---
icon: edit
date: 2023-02-03
category:
  - VuePress
tag:
  - 部署
  - GitHub pages
  - Gitee pages
---

# 我的博客部署之路

## 概述

在使用 [VuePress Theme Hope](https://theme-hope.vuejs.press/zh/) 主题完成自定义的博客开发后，我迫不及待地开始部署博客，秉着提高访问速度的原则，我开始寻找部署到除 [GitHub pages](https://docs.github.com/zh/pages) 外的方法，可这一路似乎没有我想象中那么顺利

<!-- more -->

## 部署至 GitHub pages

### 基本步骤

如果你是通过 [vuepress-theme-hope](https://theme-hope.vuejs.press/zh/cookbook/tutorial/create.html) 主题创建的 VuePress 项目，那么部署博客至 GitHub pages 将会非常容易：

#### 1. 确保在创建项目时**勾选**了创建自动部署文档的 GitHub 工作流

::: tip
没勾选也没关系，该步骤只是在**项目根目录**下创建一个用于 GitHub Actions 的工作流 `.yml` 文件： `.github/workflow/deploy-docs.yml` ，你完全可以手动创建这个目录，只要确保是在项目根目录下开始创建即可

若对上述名词感到陌生，可跳至[部署基本原理](#部署基本原理)
::: details 默认的 deploy-docs.yml

```yml
name: 部署文档

on:
  push:
    branches:
      # 确保这是你正在使用的分支名称
      - main

jobs:
  deploy-gh-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          # 如果你文档需要 Git 子模块，取消注释下一行
          # submodules: true

      - name: 设置 Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: npm

      - name: 安装依赖
        run: npm ci

      - name: 构建文档
        env:
          NODE_OPTIONS: --max_old_space_size=8192
        run: |-
          npm run docs:build
          > src/.vuepress/dist/.nojekyll
      - name: 部署文档
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          # 这是文档部署到的分支名称
          branch: gh-pages
          folder: src/.vuepress/dist
```

:::

#### 2. 选择 GitHub pages

[GitHub pages](https://docs.github.com/zh/pages) 分为个人页面与项目页面：

- 个人页面：

  1. 必须将整个项目上传至如下仓库：  
     `https://github.com/GitHub用户名/GitHub用户名.github.io`  
     这意味着你在创建仓库时，仓库名必须为如下形式：  
     `GitHub用户名.github.io`
  2. 部署成功后的网址为 `https://GitHub用户名.github.io/`
  3. 每个 GitHub 账号只能部署**一个**个人页面

* 项目页面：

  1. 仓库命名没有限制，例如 `myproject`
  2. 部署成功后的网址为 `https://GitHub用户名.github.io/GitHub仓库名/`
  3. 不同于个人页面，项目页面没有数量限制

则按个人需求创建 GitHub 仓库后，配置部署站点的基础路径 [base 选项](https://v2.vuepress.vuejs.org/zh/reference/config.html)：

- 如果你选择部署至个人页面，那么你无需配置 `base` ，因为其默认值就是 `/`
- 如果你选择部署至项目页面，则必须在 `config.ts` 中配置 `base`：

```ts
import { defineUserConfig } from 'vuepress'

export default defineUserConfig({
  // 必须以 `/` 开头和结束，且路径名必须与GitHub仓库名一致，包括大小写
  base: '/myproject/'
})
```

::: warning
部署至 Gitee pages 的项目页面时，倘若你的 Gitee 仓库名中使用了大写字母，则配置 `base` 时必须转换为**小写字母**，因为 Gitee pages 在部署时会默认将部署仓库名转换为小写  
例如 Gitee 仓库名为 `My-Project`，则该项目中的 `base` 就应为 `/my-project/`  
详情参考[部署至 Gitee pages](#部署至-gitee-pages)

:::

#### 3. 触发工作流

（1） 使用 Git 管理项目后，确保当前处于主分支 `main`，因为项目默认的 `deploy-docs.yml` 文件中，是通过 `push` 指定分支（默认 `main`）的事件来触发工作流

无论你是修改 `.yml` 文件的分支名还是修改 Git 当前的分支名，都必须符合如下两点才能正确触发工作流并部署成功：

- 你所 `push` 的分支与 `.yml` 文件中的分支一样
- 该分支包含项目所有文件（例如主分支）

```yml
# 项目默认的 deploy-docs.yml
on:
  push:
    branches:
      # 确保这是你正在使用的分支名称
      - main
```

（2） 提交代码至 GitHub 仓库

执行 `git push` 将项目代码上传至你创建好的 GitHub 仓库中，上传成功后可点开仓库选项卡中的 `Actions` 选项

如果前面都配置正确，此时你会在左侧菜单栏 `All workflows` 列表中看到一个名为 `部署文档` （项目默认工作流名字）的工作流正在运行，它正是你在 `push` 分支 `main` 时触发的工作流，等待一两分钟便可知道运行结果，也可点击该工作流，进入实时的**可视化运行图表**来查看具体的工作流进度

![](/articles/vuepress/actions.webp)

如果你是**第一次**使用 GitHub Actions，那么上述的工作流大概率会运行失败  
因为每个 GitHub 仓库都**默认**只让 GitHub Actions 读取仓库内容，**不允许读写**，因此需为 GitHub Actions 开放当前仓库的读写权限，否则无法正常构建 GitHub pages

点击仓库选项卡 `Settings`→`Actions`→`General`，在 `Workflow permissions`中选择读写权限 `Read and write permissions`后点击保存即可

![](/articles/vuepress/workflowPermissions.webp)

::: tip
当然你也可以在第一次 `push` 前就修改当前仓库的 GitHub Actions 权限
:::

修改权限后，你可以选择再次执行 `git push` 以触发工作流（无任何修改的 push 不行），或者点开 `Actions` 选项卡，由于当前工作流比较简单，因此在等待两分钟左右即可看到工作流运行成功的绿色箭头，同时你会看到一个名为 `pages build and deployment` 的工作流在运行，它由 GitHub pages 触发，当它也运行成功后，离部署成功就很近了

点击仓库选项卡 `Settings`-`Pages`，在 `Build and deployment` 的 `Source` 中选择从一个分支中部署，并在下面的 `Branch` 中选择 `gh-pages`，它是项目默认部署的分支

选择后不要急着点击上方的部署网址（404 页面），因为 GitHub pages 会再次触发新的 `pages build and deployment` 工作流，你可以切换到 `Actions` 选择中去查看，通常只要等待一两分钟就运行成功，此时再去点击部署网址就会发现，成功啦:smile:！

### 部署基本原理

上面讲了一大堆 GitHub Actions，那它到底是什么呢？为什么只要在 push 指定分支时就能自动部署博客呢？

GitHub Actions 是一个实现持续集成（Continuous integration）和持续交付（Continuous delivery）的平台，你可粗略地理解为一个执行脚本命令的平台  
当你为项目创建了一个工作流，即一系列的脚本命令后，工作流中设置在发生 `git push main` 这一特定动作时，就开始执行这个工作流，即开始在 GitHub Actions 的虚拟机运行器（runner）上执行一系列的脚本命令

举个例子，在每次修改博文后，你都需要手动构建，上传代码进行部署，在其他 Web 应用中可能还需要测试，这些每次部署都会重复执行的动作，便可理解为 Actions，只不过现在由 GitHub Actions 自动为我们在虚拟运行器通过脚本命令执行

::: tip 深入学习
如果想深入了解 GitHub Actions，可参考[这篇文章](https://github.com/mqyqingfeng/Blog/issues/237)或 [GitHub Actions 官方中文文档](https://docs.github.com/zh/actions/learn-github-actions/understanding-github-actions)
:::

不同的 Actions 可执行不同的任务，因此可以使用别人创建好的 Action，回到部署博客中，参考我的博客[工作流代码](https://github.com/Wu-JunHui/Wu-JunHui.github.io/blob/main/.github/workflows/deploy-docs.yml)，每一步我都编写了详细的注释，因此我只列出大致流程：

https://github.com/marketplace?type=actions
Actions 市场

1. 检查仓库代码
2. 安装 Node.js
3. 安装项目依赖
4. 构建文档，即 build
5. 部署文档至 GitHub pages
6. 同步当前仓库代码到 Gitee
7. 部署文档至 Gitee pages
   同时你也可以参考当前网站的 Actions，每一步我都详细地注释

### 参考：

[vuepress-theme-hope/部署项目](https://theme-hope.vuejs.press/zh/cookbook/tutorial/deploy.html)

借助 GitHub Actions，当前仓库能在 `push` 主分支 `main` （可自定义）时，自动将博客部署至 GitHub pages 和 Gitee pages 的 `gh-pages` 分支

### 部署至 GitHub pages

主题 [vuepress-theme-hope](https://github.com/vuepress-theme-hope/vuepress-theme-hope) 通过 GitHub Actions，提供了部署至 GitHub pages 的便捷功能，需确保符合以下要求：

1. 确保在创建 vuepress-theme-hope 项目时勾选了创建自动部署文档的 GitHub 工作流
2.

### 部署至 Gitee pages

同样需要借助于 GitHub Actions，我使用的是 [yanglbme/gitee-pages-action](https://github.com/yanglbme/gitee-pages-action)，该作者的仓库下的 `README.md` 已有详细的使用教程，此处不再重复

### 部署基本原理

自定义域名：为了规避被审查的未知风险，我还是选择了其他方
先说结论：只要是在国内的服务器，无论是部署在

总结

上述是我不断踩坑的博客部署之路，可能会
